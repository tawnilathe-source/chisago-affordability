
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chisago Lakes Home Affordability Calculator</title>
  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brandblue: '#486fb7',
            brandtext: '#333a56',
            brandwhite: '#FFFFFF'
          },
          borderRadius: {
            '2xl': '1rem'
          }
        }
      }
    }
  </script>
  <style>
    /* Ensure sliders use brand color in non-Tailwind-compatible browsers */
    input[type=range]::-webkit-slider-thumb { background: #486fb7; }
    input[type=range]::-moz-range-thumb { background: #486fb7; }
    input[type=range] { accent-color: #486fb7; }
  </style>
</head>
<body class="min-h-screen bg-brandwhite text-brandtext">
  <div id="root"></div>

  <!-- React + ReactDOM (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel for in-browser JSX transform -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    const fmtCurrency0 = (n) => n.toLocaleString(undefined, { style: "currency", currency: "USD", maximumFractionDigits: 0 });
    const fmtPct1 = (n) => n.toFixed(1) + "%";

    const monthlyRate = (aprPct) => (aprPct / 100) / 12;
    const pmt = (rate, nper, pv) => (rate === 0 ? pv / nper : (pv * rate) / (1 - Math.pow(1 + rate, -nper)));

    function App() {
      const [income, setIncome] = useState(100000);
      const [debts, setDebts] = useState(300);
      const [rate, setRate] = useState(6.75);
      const [term, setTerm] = useState(30);
      const [downPct, setDownPct] = useState(5);
      const [hoa, setHoa] = useState(0);
      const [taxPct, setTaxPct] = useState(1.05);
      const [insPct, setInsPct] = useState(0.70);
      const [pmiPct, setPmiPct] = useState(0.80);
      const [autoRate, setAutoRate] = useState(true);

      // Hidden DTI caps
      const frontDTI = 28, backDTI = 36;

      // Optional: set window.RATE_FEED_URL to a JSON endpoint returning { average30yr: number }
      useEffect(() => {
        if (!autoRate) return;
        const url = window.RATE_FEED_URL || "";
        let aborted = false;
        (async () => {
          try {
            if (url) {
              const res = await fetch(url);
              if (!aborted && res.ok) {
                const data = await res.json();
                if (typeof data.average30yr === "number" && data.average30yr > 0 && data.average30yr < 20) {
                  setRate(parseFloat(data.average30yr.toFixed(2)));
                }
              }
            }
          } catch {}
        })();
        return () => { aborted = true; };
      }, [autoRate]);

      const months = term * 12;
      const mr = monthlyRate(rate);

      const results = useMemo(() => {
        const grossMonthly = income / 12;
        const maxHousingFront = grossMonthly * (frontDTI / 100);
        const maxHousingBack = Math.max(0, grossMonthly * (backDTI / 100) - debts);
        const cap = Math.min(maxHousingFront, maxHousingBack);

        const compute = (price) => {
          const down = price * (downPct / 100);
          const loan = Math.max(0, price - down);
          const pi = pmt(mr, months, loan);
          const tax = (price * (taxPct / 100)) / 12;
          const ins = (price * (insPct / 100)) / 12;
          const pmi = downPct < 20 ? (loan * (pmiPct / 100)) / 12 : 0;
          const piti = pi + tax + ins + pmi;
          const total = piti + hoa;
          return { down, loan, pi, tax, ins, pmi, piti, total };
        };

        let lo = 50000, hi = 1500000, best = compute(50000);
        for (let i = 0; i < 48; i++) {
          const mid = (lo + hi) / 2;
          const c = compute(mid);
          if (c.total > cap) hi = mid; else { lo = mid; best = c; }
        }

        const price = lo;
        const c = compute(price);
        const cushion = cap - c.total;
        const tier = cushion < -50 ? "Tight" : cushion > 400 ? "Comfortable" : "On Target";

        return { grossMonthly, cap, price, ...c, cushion, tier };
      }, [income, debts, rate, term, downPct, hoa, taxPct, insPct, pmiPct, months, mr]);

      return (
        <div className="mx-auto max-w-6xl px-4 py-8">
          <header className="mb-6">
            <h1 className="text-3xl md:text-4xl font-bold text-brandtext tracking-tight">
              How much house can I afford in Chisago Lakes, MN?
            </h1>
            <p className="mt-2 text-brandtext">
              Adjust the sliders and see your maximum estimated price update instantly. We include taxes, insurance, and PMI (when applicable).
            </p>
          </header>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Controls */}
            <section className="space-y-5">
              <Panel title="Income & Debts">
                <SliderRow label="Household income (before tax)" value={income} setValue={setIncome} min={20000} max={300000} step={1000} format={fmtCurrency0} />
                <SliderRow label="Other monthly debts" value={debts} setValue={setDebts} min={0} max={3000} step={25} format={fmtCurrency0} help="Car loans, student loans, credit card minimums." />
              </Panel>

              <Panel title="Loan details">
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <ToggleCard label="Loan term" options={[15,30]} value={term} onChange={setTerm} format={(v)=>`${v} yrs`} />
                  <ToggleCard label="Rate source" options={["Auto","Manual"]} value={autoRate ? "Auto" : "Manual"} onChange={(v)=>setAutoRate(v === 'Auto')} />
                </div>
                <SliderRow label="Interest rate (APR)" value={rate} setValue={setRate} min={2} max={12} step={0.05} format={(v)=>`${v.toFixed(2)}%`} />
                <SliderRow label="Down payment (%)" value={downPct} setValue={setDownPct} min={0} max={30} step={0.5} format={fmtPct1} />
                <p className="text-[11px] text-brandtext mt-1">Default down payment is 5%.</p>
              </Panel>

              <Panel title="Property costs (Minnesota defaults)">
                <SliderRow label="Property tax (% of price / yr)" value={taxPct} setValue={setTaxPct} min={0.5} max={2.0} step={0.05} format={fmtPct1} />
                <SliderRow label="Homeowners insurance (% of price / yr)" value={insPct} setValue={setInsPct} min={0.2} max={1.2} step={0.05} format={fmtPct1} />
                <SliderRow label="PMI (% of loan / yr when <20% down)" value={pmiPct} setValue={setPmiPct} min={0.4} max={1.8} step={0.05} format={fmtPct1} />
                <SliderRow label="HOA (monthly)" value={hoa} setValue={setHoa} min={0} max={600} step={10} format={fmtCurrency0} />
                <p className="text-[11px] text-brandtext mt-2">Defaults: Taxes ~1.05%, Insurance ~0.70% (≈$2.1k on a $300k home), PMI typically 0.5–1.5%. Adjust for your property.</p>
              </Panel>
            </section>

            {/* Results */}
            <aside className="md:sticky md:top-6 h-fit">
              <div className="rounded-2xl border bg-brandwhite shadow-sm p-6">
                <div className="flex items-center gap-2 mb-2">
                  <div className="w-5 h-5 rounded bg-brandblue"></div>
                  <h2 className="text-lg font-semibold text-brandtext">Your estimate</h2>
                </div>

                <div className="text-sm text-brandtext">
                  Max monthly housing (cap): <span className="font-medium">
                    {fmtCurrency0(((income/12) * (frontDTI/100)) < ((income/12) * (backDTI/100) - debts) ? (income/12) * (frontDTI/100) : Math.max(0, (income/12) * (backDTI/100) - debts))}
                  </span>
                </div>

                <div className="mt-2">
                  <div className="text-xs text-brandtext">Estimated maximum home price</div>
                  <div className="text-3xl md:text-4xl font-bold text-brandtext">{fmtCurrency0(results.price)}</div>
                  <div className="text-sm text-brandtext mt-1">Estimated down: {fmtCurrency0(results.down)} • Loan: {fmtCurrency0(results.loan)}</div>
                </div>

                <div className="mt-4 grid grid-cols-2 gap-2 text-sm">
                  <KV k="Principal & interest" v={fmtCurrency0(results.pi)} />
                  <KV k="Property taxes" v={fmtCurrency0(results.tax)} />
                  <KV k="Homeowners insurance" v={fmtCurrency0(results.ins)} />
                  <KV k="PMI" v={fmtCurrency0(results.pmi)} />
                  <KV k="HOA" v={fmtCurrency0(hoa)} />
                  <KV k="Total PITI + HOA" v={fmtCurrency0(results.total)} />
                </div>

                <div className="mt-4 rounded-xl bg-slate-50 p-3 text-xs text-brandtext flex gap-2">
                  <div className="w-4 h-4 rounded bg-brandblue mt-0.5"></div>
                  <p>
                    {results.tier === 'Tight' && 'This looks a bit tight vs common guidelines. Consider a lower price, larger down payment, or paying down other debts.'}
                    {results.tier === 'On Target' && 'This fits common guidelines. A lender can fine‑tune approval based on credit and program.'}
                    {results.tier === 'Comfortable' && 'You’re well under the cap. Keep the cushion or explore slightly higher price points.'}
                  </p>
                </div>

                <div className="mt-5">
                  <button onclick="document.getElementById('lead-gate').showModal()" className="w-full rounded-xl bg-brandblue text-white py-3 font-medium hover:brightness-90">Get a custom approval & local listings</button>
                  <p className="text-[11px] text-brandtext mt-2">Educational estimate only. Actual approvals vary by credit, program, reserves, and property.</p>
                </div>
              </div>
            </aside>
          </div>

          {/* Lead modal */}
          <dialog id="lead-gate" className="rounded-2xl p-0 w-[95%] max-w-lg">
            <form method="dialog">
              <div className="p-6">
                <div className="flex items-center justify-between mb-3">
                  <h3 className="text-xl font-semibold text-brandtext">Send me my numbers</h3>
                  <button className="text-brandtext hover:text-brandblue">✕</button>
                </div>
                <p className="text-sm text-brandtext mb-4">We’ll run Chisago Lakes‑specific taxes/insurance and email you a lender‑ready estimate + matching listings.</p>
                <LeadForm />
              </div>
            </form>
          </dialog>
        </div>
      );
    }

    function Panel({ title, children }) {
      return (
        <div className="rounded-2xl border bg-brandwhite p-5 shadow-sm">
          <div className="text-base font-semibold mb-3 text-brandtext">{title}</div>
          {children}
        </div>
      );
    }

    function SliderRow({ label, value, setValue, min, max, step, format, help }) {
      return (
        <div className="mb-4 last:mb-0">
          <div className="flex items-end justify-between">
            <div className="text-sm font-medium text-brandtext">{label}</div>
            <div className="text-sm text-brandtext">{format ? format(value) : value}</div>
          </div>
          <input type="range" min={min} max={max} step={step} value={value}
                 onChange={(e)=>setValue(parseFloat(e.target.value))}
                 className="w-full accent-brandblue" />
          <div className="flex justify-between text-[11px] text-brandtext">
            <span>{format ? format(min) : min}</span>
            <span>{format ? format(max) : max}</span>
          </div>
          {help && <div className="text-[11px] text-brandtext mt-1">{help}</div>}
        </div>
      );
    }

    function KV({ k, v }) {
      return (
        <div className="flex items-center justify-between bg-slate-50 rounded-lg px-3 py-2">
          <span className="text-brandtext">{k}</span>
          <span className="font-medium text-brandtext">{v}</span>
        </div>
      );
    }

    function LeadForm() {
      const [name, setName] = React.useState("");
      const [email, setEmail] = React.useState("");
      const [phone, setPhone] = React.useState("");
      const [timeline, setTimeline] = React.useState("0-3 months");

      const submit = (e) => {
        e.preventDefault();
        alert("Thanks! We'll send your custom approval and listings.");
        document.getElementById('lead-gate').close();
        setName(""); setEmail(""); setPhone(""); setTimeline("0-3 months");
      };

      return (
        <form onSubmit={submit} className="grid sm:grid-cols-2 gap-3">
          <Field label="Full name"><input required value={name} onChange={(e)=>setName(e.target.value)} className="w-full rounded-xl border px-3 py-2" /></Field>
          <Field label="Email"><input required type="email" value={email} onChange={(e)=>setEmail(e.target.value)} className="w-full rounded-xl border px-3 py-2" /></Field>
          <Field label="Phone"><input required value={phone} onChange={(e)=>setPhone(e.target.value)} className="w-full rounded-xl border px-3 py-2" /></Field>
          <Field label="Timeline">
            <select value={timeline} onChange={(e)=>setTimeline(e.target.value)} className="w-full rounded-xl border px-3 py-2">
              <option>0-3 months</option>
              <option>3-6 months</option>
              <option>6-12 months</option>
              <option>12+ months</option>
              <option>Just browsing</option>
            </select>
          </Field>
          <div className="sm:col-span-2">
            <button type="submit" className="w-full rounded-xl bg-brandblue text-white py-3 font-medium hover:brightness-90">
              Email me my results
            </button>
            <p className="text-[11px] text-brandtext mt-2">
              By submitting, you agree to be contacted by The Leonhardt Team via phone/text/email. Msg/data rates may apply.
            </p>
          </div>
        </form>
      );
    }

    function Field({ label, children }) {
      return (
        <div>
          <div className="text-xs font-medium text-brandtext mb-1">{label}</div>
          {children}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
